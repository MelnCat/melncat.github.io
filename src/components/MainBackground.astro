<div class="bg">
	<div class="overlay">
		<canvas id="bgCanvas"></canvas>
	</div>
	<slot />
</div>

<script>
	const canvas = document.getElementById("bgCanvas") as HTMLCanvasElement;
	canvas.width = canvas.clientWidth;
	canvas.height = canvas.clientHeight;

	const ctx = canvas.getContext("2d")!;
	const rand = (min: number, max: number) => Math.random() * (max - min) + min;

	const objScreenWidth = canvas.width * 2;
	const objs: { x: number; y: number; w: number; h: number; z: number }[] = [];
	for (let z = 1.2; z <= 40; z++) {
		for (let x = rand(-100, 0); x < objScreenWidth / (0.4 + 0.6 * (1 / z)); ) {
			const w = rand(50, 90);
			const h = rand(100, 600);
			objs.push({ x, y: canvas.height, w, h, z: 1 - 1 / z });
			x += w;
			x += rand(20, 50);
			if (Math.random() > 0.5) x += rand(20, 50);
		}
	}

	let last = 0;
	const render = (t: number) => {
		const delta = t - last;
		last = t;
		const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
		gradient.addColorStop(0, "#111111");
		gradient.addColorStop(0.3, "#223172");
		gradient.addColorStop(0.6, "#c76569");
		gradient.addColorStop(1, "#f9b53c");

		ctx.fillStyle = gradient;

		ctx.fillRect(0, 0, canvas.width, canvas.height);

		const floor = 200;

		const floorGradient = ctx.createLinearGradient(0, canvas.height - floor, 0, canvas.height);
		floorGradient.addColorStop(0, "#004400");
		floorGradient.addColorStop(1, "#000000");
		ctx.fillStyle = "#004400";
		ctx.fillRect(0, canvas.height - floor, canvas.width, canvas.height);
		for (const obj of objs) {
			obj.x -= delta / 10;
			const zScale = 0.4 + 0.6 * (1 - obj.z);
			if (obj.x < -obj.w) obj.x += objScreenWidth / zScale;
		}
		const sorted = objs.sort((a, b) =>
			Math.abs(b.z - a.z) < 0.01
				? Math.abs(b.x - objScreenWidth / 2 - canvas.width / 2) - Math.abs(a.x - objScreenWidth / 2 - canvas.width / 2)
				: b.z - a.z,
		);
		for (const obj of sorted) {
			let { x, y, w, h, z } = obj;
			x -= objScreenWidth / 2;
			const fZ = z;
			const fZScale = 0.4 + 0.6 * (1 - fZ);
			const fY = y - floor * fZ;
			const fX = (x - canvas.width / 2) * fZScale + canvas.width / 2;
			const fW = w * fZScale;
			const fH = h * fZScale;

			const bZ = z + 0.1;
			const bZScale = 0.4 + 0.6 * (1 - bZ);
			const bY = y - floor * bZ;
			const bX = (x - canvas.width / 2) * bZScale + canvas.width / 2;
			const bW = w * bZScale;
			const bH = h * bZScale;

			const fBL = [fX - fW / 2, fY] as const;
			const fBR = [fX + fW / 2, fY] as const;
			const fTR = [fX + fW / 2, fY - fH] as const;
			const fTL = [fX - fW / 2, fY - fH] as const;
			const bBL = [bX - bW / 2, bY] as const;
			const bBR = [bX + bW / 2, bY] as const;
			const bTR = [bX + bW / 2, bY - bH] as const;
			const bTL = [bX - bW / 2, bY - bH] as const;

			const l = (b: number) =>
				Math.floor((1 - z) * 0x20 + b * 0x10)
					.toString(16)
					.padStart(2, "0")
					.repeat(3);
			ctx.fillStyle = `#${l(0)}`;

			ctx.fillStyle = `#${l(1)}`;

			const renderTop = () => {
				ctx.beginPath();
				ctx.moveTo(...fTL);
				ctx.lineTo(...fTR);
				ctx.lineTo(...bTR);
				ctx.lineTo(...bTL);
				ctx.closePath();
				ctx.fill();
			};

			if (bTR[1] > fTR[1]) renderTop();

			const renderLeft = () => {
				ctx.beginPath();
				ctx.moveTo(...fTL);
				ctx.lineTo(...bTL);
				ctx.lineTo(...bBL);
				ctx.lineTo(...fBL);
				ctx.closePath();
				ctx.fill();
			};

			const renderRight = () => {
				ctx.fillStyle = `#${l(2)}`;
				ctx.beginPath();
				ctx.moveTo(...fTR);
				ctx.lineTo(...bTR);
				ctx.lineTo(...bBR);
				ctx.lineTo(...fBR);
				ctx.closePath();
				ctx.fill();
			};

			renderLeft();
			renderRight();

			if (bTR[1] < fTR[1]) renderTop();
			ctx.fillStyle = `#${l(3)}`;
			ctx.beginPath();
			ctx.moveTo(...fBL);
			ctx.lineTo(...fBR);
			ctx.lineTo(...fTR);
			ctx.lineTo(...fTL);
			ctx.closePath();
			ctx.fill();
		}
		requestAnimationFrame(render);
	};

	render(0);
</script>

<style>
	.bg {
		height: 100%;
		flex-grow: 1;
		position: relative;
		background-color: var(--color-bg-dark);
		display: flex;
		flex-direction: column;
		z-index: 0;
	}
	#bgCanvas {
		width: 100%;
		height: 100%;
	}
	.overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: -1;
	}
</style>

<script
